<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÁÆÄÂçïÂõæÂÉèÊºîÁ§∫</title>
    <style>
        body {
            font-family: 'Segoe UI', 'PingFang SC', 'Microsoft YaHei', sans-serif;
            margin: 0;
            padding: 20px;
            background: #f8fafc;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            color: #1e293b;
            margin-bottom: 30px;
        }

        .images-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .image-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .image-card h3 {
            margin: 0 0 15px 0;
            color: #374151;
            font-size: 1.1rem;
        }

        .image-placeholder {
            width: 100%;
            height: 200px;
            border: 2px dashed #d1d5db;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #6b7280;
            font-size: 14px;
            margin-bottom: 10px;
        }

        .image-placeholder img {
            max-width: 100%;
            max-height: 100%;
            border-radius: 8px;
            object-fit: contain;
        }

        .status {
            font-size: 12px;
            padding: 4px 8px;
            border-radius: 4px;
            font-weight: 500;
        }

        .status.loading {
            background: #dbeafe;
            color: #1d4ed8;
        }

        .status.success {
            background: #dcfce7;
            color: #047857;
        }

        .status.error {
            background: #fee2e2;
            color: #b91c1c;
        }

        .log-section {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .log-container {
            background: #1f2937;
            color: #f3f4f6;
            padding: 12px;
            border-radius: 8px;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 11px;
            height: 150px;
            overflow-y: auto;
        }

        .log-entry {
            margin-bottom: 2px;
            white-space: pre-wrap;
        }

        .log-info { color: #60a5fa; }
        .log-success { color: #34d399; }
        .log-warning { color: #fbbf24; }
        .log-error { color: #f87171; }

        .section {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .section h2 {
            margin-top: 0;
            margin-bottom: 15px;
            color: #374151;
            font-size: 1.3rem;
        }

        .table-controls {
            margin-bottom: 15px;
        }

        .table-controls button {
            background: #2563eb;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            margin-right: 10px;
            margin-bottom: 5px;
            font-size: 14px;
        }

        .table-controls button:hover {
            background: #1d4ed8;
        }

        .table-controls button:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }

        .table-container {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }

        th, td {
            border: 1px solid #e5e7eb;
            padding: 12px;
            text-align: left;
        }

        th {
            background: #f9fafb;
            font-weight: 600;
            color: #374151;
        }

        td {
            color: #6b7280;
        }

        .image-path {
            max-width: 300px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .image-path:hover {
            background-color: #f3f4f6;
        }

        .status-tag {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
        }

        .status-tag.processed {
            background: #dcfce7;
            color: #047857;
        }

        .status-tag.pending {
            background: #fef3c7;
            color: #b45309;
        }

        @media (max-width: 768px) {
            .images-grid {
                grid-template-columns: 1fr;
            }

            .table-controls button {
                width: 100%;
                margin-bottom: 8px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üì∏ ÂõæÂÉèÊºîÁ§∫ - ÈõÜÊàêË°®Ê†ºÂäüËÉΩ</h1>


        <!-- Ë°®Ê†ºÊºîÁ§∫ -->
        <div class="section">
            <h2>Ë°®Ê†ºÂõæÂÉèÈ¢ÑËßà</h2>
            <div class="table-controls">
                <button id="replaceWithImages">ÊõøÊç¢‰∏∫ÂõæÂÉè</button>
                <button id="restoreTable">ÊÅ¢Â§çË°®Ê†º</button>
                <button id="clearCache">Ê∏ÖÁêÜÁºìÂ≠ò</button>
            </div>

            <div class="table-container">
                <table id="demoTable">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>ÂõæÂÉèË∑ØÂæÑ</th>
                            <th>ÂàõÂª∫Êó∂Èó¥</th>
                            <th>Áä∂ÊÄÅ</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>001</td>
                            <td class="image-path">images/test/1.png</td>
                            <td>2025-09-18 10:30:00</td>
                            <td><span class="status-tag processed">Â∑≤Â§ÑÁêÜ</span></td>
                        </tr>
                        <tr>
                            <td>002</td>
                            <td class="image-path">images/test/2.png</td>
                            <td>2025-09-18 11:15:30</td>
                            <td><span class="status-tag processed">Â∑≤Â§ÑÁêÜ</span></td>
                        </tr>
                        <tr>
                            <td>003</td>
                            <td class="image-path">images/test/3.png</td>
                            <td>2025-09-18 11:15:30</td>
                            <td><span class="status-tag processed">Â∑≤Â§ÑÁêÜ</span></td>
                        </tr>
                        <tr>
                            <td>004</td>
                            <td class="image-path">images/test/4.png</td>
                            <td>2025-09-18 11:15:30</td>
                            <td><span class="status-tag processed">Â∑≤Â§ÑÁêÜ</span></td>
                        </tr>
                        <tr>
                            <td>005</td>
                            <td class="image-path">images/test/5.png</td>
                            <td>2025-09-18 11:15:30</td>
                            <td><span class="status-tag processed">Â∑≤Â§ÑÁêÜ</span></td>
                        </tr>
                        <tr>
                            <td>006</td>
                            <td class="image-path">images/test/6.png</td>
                            <td>2025-09-18 11:15:30</td>
                            <td><span class="status-tag processed">Â∑≤Â§ÑÁêÜ</span></td>
                        </tr>
                        <tr>
                            <td>007</td>
                            <td class="image-path">images/test/7.png</td>
                            <td>2025-09-18 11:15:30</td>
                            <td><span class="status-tag processed">Â∑≤Â§ÑÁêÜ</span></td>
                        </tr>
                        <tr>
                            <td>008</td>
                            <td class="image-path">images/test/8.png</td>
                            <td>2025-09-18 11:15:30</td>
                            <td><span class="status-tag processed">Â∑≤Â§ÑÁêÜ</span></td>
                        </tr>
                        <tr>
                            <td>009</td>
                            <td class="image-path">images/test/9.png</td>
                            <td>2025-09-18 11:15:30</td>
                            <td><span class="status-tag processed">Â∑≤Â§ÑÁêÜ</span></td>
                        </tr>
                        <tr>
                            <td>010</td>
                            <td class="image-path">images/test/10.png</td>
                            <td>2025-09-18 11:15:30</td>
                            <td><span class="status-tag processed">Â∑≤Â§ÑÁêÜ</span></td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="log-section">
            <h3 style="margin-top: 0;">Âä†ËΩΩÊó•Âøó</h3>
            <div class="log-container" id="logContainer"></div>
        </div>
    </div>

    <!-- ÂºïÂÖ•‰æùËµñÁöÑJSÊñá‰ª∂ -->
    <script src="webrtc_chunker.js"></script>
    <script src="image_access_client.js"></script>
    <script src="table_image_helper.js"></script>

    <script>
        // Êó•ÂøóÂáΩÊï∞
        function appendLog(message, level = 'info') {
            const container = document.getElementById('logContainer');
            const time = new Date().toLocaleTimeString();
            const entry = document.createElement('div');
            entry.className = `log-entry log-${level}`;
            entry.textContent = `[${time}] ${message}`;
            container.appendChild(entry);
            container.scrollTop = container.scrollHeight;

            // ÈôêÂà∂Êó•ÂøóÊù°Êï∞
            while (container.children.length > 50) {
                container.removeChild(container.firstChild);
            }
        }

        // ÂàõÂª∫ÂõæÂÉèËÆøÈóÆÂÆ¢Êà∑Á´Ø
        const client = new ImageAccessClient({
            INTERNAL_IP: '172.31.144.1',
            INTERNAL_PORT: 5002,
            SIGNALING_URL: 'ws://120.55.85.213:8081',
            AUTH_URL: 'http://120.55.85.213:8081',
            API_KEY: 'UvbYOGVn16HFhWCGMk5LYINH09UysWIZEthkBNELQbUeEIgFhrkszZRBrg35LfgF',
            IMAGE_ENDPOINT: '/api/images/by-path',
            LAN_TIMEOUT_MS: 3500,
            LOG_ENABLED: true,
            LOG_CALLBACK: appendLog
        });

        // ÂàõÂª∫Ë°®Ê†ºÂõæÂÉèÂä©Êâã
        const tableHelper = new TableImageHelper(client);

        // ‰øùÂ≠òË°®Ê†ºÂéüÂßãÊï∞ÊçÆ
        const originalTableData = {};


        // ‰øùÂ≠òË°®Ê†ºÂéüÂßãÊï∞ÊçÆ
        function saveOriginalTableData() {
            const cells = document.querySelectorAll('#demoTable .image-path');
            cells.forEach((cell, index) => {
                originalTableData[index] = cell.innerHTML;
            });
        }

        // ÊÅ¢Â§çË°®Ê†ºÂéüÂßãÊï∞ÊçÆ
        function restoreTableData() {
            const cells = document.querySelectorAll('#demoTable .image-path');
            cells.forEach((cell, index) => {
                if (originalTableData[index]) {
                    cell.innerHTML = originalTableData[index];
                    cell.style.cursor = 'pointer';
                }
            });

            // ÈáçÁΩÆÊåâÈíÆÁä∂ÊÄÅ
            document.getElementById('replaceWithImages').disabled = false;
            document.getElementById('replaceWithImages').textContent = 'ÊõøÊç¢‰∏∫ÂõæÂÉè';

            appendLog('Ë°®Ê†ºÂ∑≤ÊÅ¢Â§ç‰∏∫ÂéüÂßãÁä∂ÊÄÅ', 'info');
        }


        document.getElementById('replaceWithImages').addEventListener('click', async () => {
            const btn = document.getElementById('replaceWithImages');

            // Ê£ÄÊü•ÁΩëÁªúÁä∂ÊÄÅ
            const networkMode = client.getNetworkMode();
            if (!networkMode) {
                appendLog('‚ö†Ô∏è ÁΩëÁªúÁéØÂ¢ÉÊú™Ê£ÄÊµãÔºåËØ∑Á≠âÂæÖÁ≥ªÁªüÂàùÂßãÂåñÂÆåÊàê', 'warning');
                return;
            }

            // Ê£ÄÊü•WebRTCËøûÊé•Áä∂ÊÄÅ
            if (networkMode === 'remote' && !client.isWebRTCReady()) {
                appendLog('‚ö†Ô∏è WebRTCËøûÊé•Êú™Â∞±Áª™Ôºå‰º†ËæìÂèØËÉΩ‰ºöÊúâÂª∂Ëøü', 'warning');
                appendLog('üîÑ Âª∫ËÆÆÂà∑Êñ∞È°µÈù¢ÈáçÊñ∞Âª∫Á´ãËøûÊé•', 'info');
            }

            btn.disabled = true;
            btn.textContent = 'üöÄ ‰∏≤Ë°å‰º†Ëæì‰∏≠...';
            btn.style.background = '#f59e0b'; // ÈªÑËâ≤Ë°®Á§∫‰º†Ëæì‰∏≠

            const startTime = Date.now();
            const modeDesc = networkMode === 'lan' ? 'Â±ÄÂüüÁΩëÁõ¥Ëøû' :
                           (client.isWebRTCReady() ? 'WebRTC(Â∑≤È¢ÑËøûÊé•)' : 'WebRTC(Âª∫Á´ãËøûÊé•‰∏≠)');

            appendLog(`üöÄ ÂºÄÂßã‰∏≤Ë°åÂõæÂÉè‰º†Ëæì - Ê®°Âºè: ${modeDesc}`, 'info');

            try {
                await tableHelper.replaceTableImagesWithActual('#demoTable', '.image-path', {
                    imageSize: '80px',
                    showOriginalPath: false,
                    showFileInfo: false
                });

                const duration = Date.now() - startTime;
                appendLog(`‚úÖ ‰∏≤Ë°å‰º†ËæìÂÆåÊàêÔºÅÊÄªËÄóÊó∂: ${(duration/1000).toFixed(1)}Áßí`, 'success');
                btn.textContent = '‚úÖ Â∑≤ÊõøÊç¢';
                btn.style.background = '#10b981'; // ÁªøËâ≤Ë°®Á§∫ÊàêÂäü

            } catch (error) {
                const duration = Date.now() - startTime;
                appendLog(`‚ùå ‰∏≤Ë°å‰º†ËæìÂ§±Ë¥•ÔºåËÄóÊó∂: ${(duration/1000).toFixed(1)}Áßí`, 'error');
                appendLog(`üîç ÈîôËØØËØ¶ÊÉÖ: ${error.message}`, 'error');
                btn.disabled = false;
                btn.textContent = 'ÊõøÊç¢‰∏∫ÂõæÂÉè';
                btn.style.background = '#ef4444'; // Á∫¢Ëâ≤Ë°®Á§∫Â§±Ë¥•
            }
        });

        document.getElementById('restoreTable').addEventListener('click', restoreTableData);

        document.getElementById('clearCache').addEventListener('click', () => {
            tableHelper.clearCache();
            appendLog('ÂõæÂÉèÁºìÂ≠òÂ∑≤Ê∏ÖÁêÜ', 'info');
        });

        // È°µÈù¢Âä†ËΩΩÂÆåÊàêÂêéËá™Âä®Ê£ÄÊµãÁΩëÁªúÂπ∂Âª∫Á´ãËøûÊé•
        document.addEventListener('DOMContentLoaded', async () => {
            appendLog('üöÄ È°µÈù¢ÂàùÂßãÂåñÂÆåÊàêÔºåÂºÄÂßãËá™Âä®Ê£ÄÊµãÁΩëÁªúÁéØÂ¢É...', 'info');

            // ‰øùÂ≠òË°®Ê†ºÂéüÂßãÊï∞ÊçÆ
            saveOriginalTableData();

            try {
                // Ê≠•È™§1: Ê£ÄÊµãÁΩëÁªúÁéØÂ¢É
                appendLog('üîç Ê≠•È™§1: Ê£ÄÊµãÁΩëÁªúÁéØÂ¢É...', 'info');
                const networkMode = await client.detectNetworkMode();
                appendLog(`‚úÖ ÁΩëÁªúÁéØÂ¢ÉÊ£ÄÊµãÂÆåÊàê: ${networkMode === 'lan' ? 'Â±ÄÂüüÁΩëÊ®°Âºè' : 'WebRTCËøúÁ®ãÊ®°Âºè'}`, 'success');

                // Ê≠•È™§2: Âª∫Á´ãËøûÊé•
                if (networkMode === 'remote') {
                    appendLog('üîó Ê≠•È™§2: È¢ÑÂª∫Á´ãWebRTCËøûÊé•...', 'info');
                    appendLog('  ‚è≥ Ê≠£Âú®ËøõË°åË∫´‰ªΩËÆ§ËØÅ...', 'info');
                    appendLog('  ‚è≥ Ê≠£Âú®ËøûÊé•‰ø°‰ª§ÊúçÂä°Âô®...', 'info');
                    appendLog('  ‚è≥ Ê≠£Âú®Âª∫Á´ãWebRTCÊï∞ÊçÆÈÄöÈÅì...', 'info');

                    const connectionSuccess = await client.preEstablishWebRTCConnection();

                    if (connectionSuccess) {
                        appendLog('‚úÖ WebRTCËøûÊé•Âª∫Á´ãÊàêÂäüÔºÅÊï∞ÊçÆÈÄöÈÅìÂ∑≤Â∞±Áª™', 'success');
                        appendLog('üì° ËøûÊé•Áä∂ÊÄÅ: Â∑≤ËøûÊé•Âà∞ËøúÁ®ãÊúçÂä°Âô®', 'success');
                    } else {
                        appendLog('‚ùå WebRTCËøûÊé•Âª∫Á´ãÂ§±Ë¥•', 'error');
                        appendLog('‚ö†Ô∏è ÂõæÂÉè‰º†ËæìÂèØËÉΩ‰ºöÊúâÂª∂Ëøü', 'warning');
                    }
                } else {
                    appendLog('‚úÖ Â±ÄÂüüÁΩëÊ®°ÂºèÔºåÊó†ÈúÄÈ¢ÑÂª∫Á´ãËøûÊé•', 'success');
                    appendLog('‚ö° ËøûÊé•Áä∂ÊÄÅ: Â±ÄÂüüÁΩëÁõ¥ËøûÂ∞±Áª™', 'success');
                }

                // Ê≠•È™§3: Á≥ªÁªüÂ∞±Áª™
                appendLog('üéâ Á≥ªÁªüÂàùÂßãÂåñÂÆåÊàêÔºÅ', 'success');
                appendLog(`üìã ÂΩìÂâç‰º†ËæìÊ®°Âºè: ${networkMode === 'lan' ? 'Â±ÄÂüüÁΩëÁõ¥Ëøû(È´òÈÄü)' : 'WebRTCËøúÁ®ã(Â∑≤È¢ÑËøûÊé•)'}`, 'info');
                appendLog('üí° Áé∞Âú®ÂèØ‰ª•ÁÇπÂáª"ÊõøÊç¢‰∏∫ÂõæÂÉè"ÂºÄÂßãÈ´òÈÄü‰º†Ëæì', 'info');

                // Êõ¥Êñ∞ÊåâÈíÆÁä∂ÊÄÅ
                const btn = document.getElementById('replaceWithImages');
                if (networkMode === 'remote' && client.isWebRTCReady()) {
                    btn.style.background = '#10b981'; // ÁªøËâ≤Ë°®Á§∫Â∞±Áª™
                    btn.title = 'WebRTCËøûÊé•Â∑≤Â∞±Áª™ÔºåÂèØ‰ª•Âø´ÈÄü‰º†Ëæì';
                } else if (networkMode === 'lan') {
                    btn.style.background = '#3b82f6'; // ËìùËâ≤Ë°®Á§∫Â±ÄÂüüÁΩë
                    btn.title = 'Â±ÄÂüüÁΩëÁõ¥ËøûÊ®°ÂºèÔºåÈ´òÈÄü‰º†Ëæì';
                }

            } catch (error) {
                appendLog(`‚ùå Á≥ªÁªüÂàùÂßãÂåñÂ§±Ë¥•: ${error.message}`, 'error');
                appendLog('üîß ËØ∑Ê£ÄÊü•ÁΩëÁªúËøûÊé•ÊàñÈÖçÁΩÆ', 'error');
            }
        });

        // È°µÈù¢Âç∏ËΩΩÊó∂Ê∏ÖÁêÜËµÑÊ∫ê
        window.addEventListener('beforeunload', () => {
            client.close();
        });
    </script>
</body>
</html>